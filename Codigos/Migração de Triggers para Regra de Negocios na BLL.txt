

ğŸ¯ OBJETIVO

Migrar regras de negÃ³cio que estÃ£o nas triggers para:

BLL (regra de negÃ³cio)

ServiÃ§os transacionais

ValidaÃ§Ãµes antes do commit

Sem perder integridade.

ğŸ“Œ PASSO 1 â€” CLASSIFICAR AS TRIGGERS

Antes de remover qualquer coisa, dividimos em 3 tipos:

ğŸ”´ Tipo A â€” Regra de NegÃ³cio (deve sair do banco)

tr_calcular_subtotal_itemvenda

tr_atualiza_apos_pagamento_parcial

tr_atualiza_status_parcela

tr_atualiza_status_venda

tr_atualiza_ultima_compra_cliente

ğŸ‘‰ Essas devem ir para o cÃ³digo.

ğŸŸ¡ Tipo B â€” ValidaÃ§Ã£o

tr_valida_valor_recebido

tr_valida_validade_produto

ğŸ‘‰ Essas devem virar:

ValidaÃ§Ã£o no BLL

Ou CHECK CONSTRAINT

ğŸŸ¢ Tipo C â€” Regra estrutural simples

tr_atualiza_status_por_estoque

Essa pode virar regra dentro do EstoqueBLL.

ğŸš¨ REGRA DE OURO

NUNCA remova trigger antes de:

Criar regra equivalente no cÃ³digo

Testar em ambiente isolado

Garantir que todos os fluxos usam BLL

ğŸ”¥ ESTRATÃ‰GIA SEGURA (MIGRAÃ‡ÃƒO EM 4 FASES)
ğŸŸ¦ FASE 1 â€” Centralizar tudo na BLL

Antes de apagar trigger, vocÃª precisa garantir:

â— Nenhuma tela atualiza banco direto

Tudo deve passar por:

VendaBLL

PagamentoBLL

EstoqueBLL

FinanceiroBLL

Se alguma tela usa DAL direto â†’ vocÃª precisa corrigir isso primeiro.

ğŸŸ¦ FASE 2 â€” Reproduzir a lÃ³gica da trigger no cÃ³digo

Exemplo:

ğŸ”¹ tr_calcular_subtotal_itemvenda

Em vez de trigger:

Criar no ItemVendaBLL:

public decimal CalcularSubtotal(ItemVendaModel item)
{
    var subtotal = (item.Quantidade * item.PrecoUnitario) - (item.DescontoItem ?? 0);
    return subtotal < 0 ? 0 : subtotal;
}


E antes de salvar:

item.Subtotal = CalcularSubtotal(item);

ğŸ”¹ tr_atualiza_apos_pagamento_parcial

Em vez de somar incrementalmente:

No PagamentoBLL:

public void RecalcularValorRecebido(int parcelaId, SqlConnection conn, SqlTransaction tran)
{
    var totalPago = _pagamentoDAL.SomarPagamentos(parcelaId, conn, tran);
    _parcelaDAL.AtualizarValorRecebido(parcelaId, totalPago, conn, tran);
}


Muito mais seguro.

ğŸ”¹ tr_atualiza_status_parcela

Virar mÃ©todo:

public string CalcularStatusParcela(ParcelaModel p)
{
    if (p.Status == "Cancelada")
        return "Cancelada";

    var total = p.ValorParcela + (p.Juros ?? 0) + (p.Multa ?? 0);

    if (p.ValorRecebido >= total - 0.01m)
        return "Pago";

    if (p.ValorRecebido > 0)
        return "ParcialmentePago";

    if (p.DataVencimento < DateTime.Today)
        return "Atrasada";

    return "Pendente";
}

ğŸ”¹ tr_atualiza_status_venda

Criar mÃ©todo no VendaBLL:

public void AtualizarStatusVenda(int vendaId, SqlConnection conn, SqlTransaction tran)


E recalcular baseado nas parcelas.

ğŸŸ¦ FASE 3 â€” DESABILITAR, NÃƒO APAGAR

Quando tudo estiver funcionando via cÃ³digo:

DISABLE TRIGGER tr_nome ON Tabela;


Nunca delete primeiro.

Deixe desabilitada por 1 mÃªs.

Se nada quebrar â†’ aÃ­ sim pode dropar.

ğŸŸ¦ FASE 4 â€” TESTES DE INTEGRIDADE

Depois de desabilitar:

Criar venda

Fazer pagamento parcial

Quitar venda

Cancelar parcela

Ajustar estoque

Inserir produto vencido

Se tudo continuar consistente â†’ vocÃª venceu.

ğŸ§  POR QUE ISSO Ã‰ MAIS SEGURO?

Porque:

Trigger:

Executa ocultamente

Ordem nÃ£o garantida

DifÃ­cil debugar

Pode gerar efeito colateral

CÃ³digo:

Controle explÃ­cito

DebugÃ¡vel

TestÃ¡vel

TransaÃ§Ã£o controlada

LegÃ­vel

ERP profissional evita trigger de regra de negÃ³cio.

Trigger deve ser usada sÃ³ para:

Auditoria

Log

Bloqueio estrutural crÃ­tico

âš  IMPORTANTE

Antes de remover triggers:

Pergunta crucial:

â“ Existe alguma integraÃ§Ã£o externa que insere direto no banco?

Se existir:

VocÃª PRECISA manter alguma proteÃ§Ã£o no banco

Ou criar Stored Procedures obrigatÃ³rias

ğŸ“Œ RESUMO ESTRATÃ‰GICO

Mapear todas regras

Criar equivalente na BLL

Garantir tudo passa por BLL

Desabilitar trigger

Testar

SÃ³ depois remover

ğŸ¯ Minha recomendaÃ§Ã£o para comeÃ§ar

Comece por essa ordem:

1ï¸âƒ£ tr_calcular_subtotal_itemvenda
2ï¸âƒ£ tr_atualiza_ultima_compra_cliente
3ï¸âƒ£ tr_valida_validade_produto
4ï¸âƒ£ tr_atualiza_status_por_estoque
5ï¸âƒ£ Pagamentos e Parcelas por Ãºltimo (sÃ£o mais crÃ­ticos)


Desabilitamos a triger
DISABLE TRIGGER tr_calcular_subtotal_itemvenda ON ItemVenda;

ğŸ“Œ Status atual das 5 triggers

1ï¸âƒ£ tr_calcular_subtotal_itemvenda â†’ âœ… MIGRADA
2ï¸âƒ£ tr_atualiza_ultima_compra_cliente â†’ ğŸ”œ prÃ³xima
3ï¸âƒ£ tr_valida_validade_produto â†’ ğŸ”œ
4ï¸âƒ£ tr_atualiza_status_por_estoque â†’ ğŸ”œ
5ï¸âƒ£ Pagamentos e Parcelas â†’ ğŸ”¥ mais crÃ­tica